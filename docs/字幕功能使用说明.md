# 字幕功能使用说明

## 功能概述

已成功为 Jetstream TV Player 项目添加外挂字幕支持功能，可以在播放视频时自动加载和显示字幕。

## 已实现的功能

### 1. ✅ 字幕格式支持
- **VTT** (WebVTT) - 推荐格式
- **SRT** (SubRip) - 常见格式
- **ASS/TTML** - 预留接口（待实现）

### 2. ✅ 自动加载字幕
- 播放视频时自动加载测试字幕：`https://raw.githubusercontent.com/cjlhll/openclash-rules/refs/heads/main/test.vtt`
- 字幕与视频播放位置自动同步（100ms 精度）

### 3. ✅ 字幕控制功能
- 显示/隐藏字幕
- 切换不同字幕轨道
- 字幕选择对话框（通过控制栏字幕按钮打开）

### 4. ✅ UI 显示特性
- 半透明黑色背景，白色文字
- 居中底部显示（距离底部 120dp）
- 控制栏显示时自动隐藏字幕（避免遮挡）
- TV 友好的大字号显示（24sp）

## 文件结构

```
jetstream/src/main/java/com/google/jetstream/presentation/screens/videoPlayer/
├── subtitle/
│   ├── SubtitleItem.kt          # 字幕数据模型
│   ├── SubtitleParser.kt        # 字幕解析器（SRT/VTT）
│   ├── SubtitleManager.kt       # 字幕管理器（核心逻辑）
│   └── SubtitleOverlay.kt       # 字幕显示组件
└── VideoPlayerScreen.kt         # 已修改，集成字幕功能
```

## 使用方法

### 方式一：自动加载（已配置）

当前配置已自动加载测试字幕，无需额外操作：

```kotlin
// VideoPlayerScreen.kt 中已配置
LaunchedEffect(Unit) {
    val testSubtitles = listOf(
        SubtitleTrack(
            name = "测试字幕",
            url = "https://raw.githubusercontent.com/cjlhll/openclash-rules/refs/heads/main/test.vtt",
            language = "zh",
            format = SubtitleFormat.VTT
        )
    )
    subtitleManager.setAvailableSubtitles(testSubtitles)
    subtitleManager.loadSubtitle(testSubtitles.first())
}
```

### 方式二：在播放过程中切换字幕

1. 播放视频时，按遥控器**上键或下键**显示控制栏
2. 选中**字幕按钮**（Subtitles 图标）
3. 在字幕设置对话框中：
   - 选择"显示字幕"或"隐藏字幕"
   - 选择不同的字幕轨道（如果有多个）

### 方式三：从数据源动态加载字幕

如需从 `MovieDetails` 动态加载字幕，可以这样修改：

```kotlin
// 在 MovieDetails.kt 中添加字幕字段
data class MovieDetails(
    // ... 现有字段
    val subtitles: List<SubtitleInfo> = emptyList()
)

data class SubtitleInfo(
    val name: String,
    val url: String,
    val language: String
)

// 在 VideoPlayerScreen.kt 中使用
LaunchedEffect(movieDetails) {
    val subtitles = movieDetails.subtitles.map { info ->
        SubtitleTrack(
            name = info.name,
            url = info.url,
            language = info.language,
            format = detectSubtitleFormat(info.url) // 根据 URL 扩展名判断
        )
    }
    subtitleManager.setAvailableSubtitles(subtitles)
    
    // 自动加载第一个字幕
    subtitles.firstOrNull()?.let { subtitleManager.loadSubtitle(it) }
}
```

## 技术实现说明

### 字幕同步原理

```kotlin
// 每 100ms 轮询播放位置，查找对应的字幕
fun startSync(coroutineScope: CoroutineScope) {
    syncJob = coroutineScope.launch {
        while (isActive) {
            val currentPos = GSYVideoManager.instance().currentPosition
            currentSubtitle = findSubtitleAtPosition(currentPos)
            delay(100)
        }
    }
}
```

### VTT 字幕格式示例

```vtt
WEBVTT

02:29.200 --> 02:30.460
给我张支票 什么意思？

02:30.660 --> 02:31.290
要我踢假球？
```

### SRT 字幕格式示例

```srt
1
00:02:29,200 --> 00:02:30,460
给我张支票 什么意思？

2
00:02:30,660 --> 00:02:31,290
要我踢假球？
```

## 调试与日志

字幕相关的日志标签：
- `SubtitleManager` - 字幕加载和管理
- `VTTParser` - VTT 格式解析
- `SRTParser` - SRT 格式解析
- `VideoPlayer` - 字幕自动加载

查看日志：
```bash
adb logcat | grep -E "SubtitleManager|VTTParser|SRTParser"
```

## 已知限制

1. ⚠️ **网络延迟**：字幕文件需要从网络下载，可能有 1-3 秒延迟
2. ⚠️ **ASS/TTML 格式**：暂未实现，需要扩展解析器
3. ⚠️ **字幕样式**：目前不支持 ASS 样式（颜色、位置、动画等）
4. ⚠️ **内嵌字幕**：暂不支持视频内嵌字幕（MKV、MP4 内置字幕）

## 后续优化建议

### 1. 字幕延迟调整
```kotlin
// 在 SubtitleManager 中添加
private var delayMs: Long = 0

fun setDelay(delayMs: Long) {
    this.delayMs = delayMs
}

private fun findSubtitleAtPosition(positionMs: Long): SubtitleItem? {
    val adjustedPos = positionMs + delayMs
    // ...
}
```

### 2. 字幕样式自定义
```kotlin
data class SubtitleStyle(
    val fontSize: TextUnit = 24.sp,
    val textColor: Color = Color.White,
    val backgroundColor: Color = Color.Black.copy(alpha = 0.75f),
    val position: SubtitlePosition = SubtitlePosition.BOTTOM
)
```

### 3. 字幕缓存
```kotlin
// 将下载的字幕文件缓存到本地
suspend fun loadSubtitle(track: SubtitleTrack) {
    val cachedFile = File(context.cacheDir, "subtitle_${track.url.hashCode()}.txt")
    if (cachedFile.exists()) {
        // 使用缓存
    } else {
        // 下载并缓存
    }
}
```

### 4. 多字幕同时显示
```kotlin
// 支持双语字幕（如中文 + 英文）
val primarySubtitle: SubtitleItem?
val secondarySubtitle: SubtitleItem?
```

## 测试清单

- [ ] 播放视频时字幕自动加载
- [ ] 字幕与视频同步显示
- [ ] 长按快进/快退时字幕正常跟随
- [ ] 控制栏显示时字幕自动隐藏
- [ ] 字幕按钮可以打开选择对话框
- [ ] 可以切换显示/隐藏字幕
- [ ] 退出播放器时字幕停止同步
- [ ] 内核切换时字幕继续工作

## 故障排查

### 问题 1：字幕不显示

**可能原因**：
1. 字幕文件下载失败（检查网络）
2. 字幕格式解析错误（检查日志）
3. 字幕被禁用了（检查 `subtitleEnabled` 状态）

**解决方法**：
```bash
# 查看日志
adb logcat | grep SubtitleManager

# 检查字幕是否下载成功
# 应该看到：Loaded XX subtitle items
```

### 问题 2：字幕时间不同步

**可能原因**：
1. 字幕文件的时间戳与视频不匹配
2. 轮询间隔太长（100ms）

**解决方法**：
1. 调整字幕延迟（待实现功能）
2. 减少轮询间隔到 50ms

### 问题 3：字幕文字显示异常

**可能原因**：
1. 字幕文件编码不是 UTF-8
2. 特殊字符未正确处理

**解决方法**：
确保字幕文件使用 UTF-8 编码

## 参考资源

- [WebVTT 规范](https://www.w3.org/TR/webvtt1/)
- [SRT 格式说明](https://en.wikipedia.org/wiki/SubRip)
- [GSYVideoPlayer 字幕 Demo](https://github.com/CarGuo/GSYVideoPlayer/tree/master/app/src/main/java/com/example/gsyvideoplayer/exosubtitle)

---

**文档版本**：v1.0  
**更新日期**：2025-10-24  
**测试字幕链接**：https://raw.githubusercontent.com/cjlhll/openclash-rules/refs/heads/main/test.vtt

