# 字幕功能实现总结

## ✅ 已完成的工作

### 1. 创建的新文件（4个）

#### 📁 `subtitle/SubtitleItem.kt`
- 定义字幕数据模型 `SubtitleItem`
- 定义字幕轨道模型 `SubtitleTrack`
- 定义字幕格式枚举 `SubtitleFormat`（SRT/VTT/ASS/TTML）

#### 📁 `subtitle/SubtitleParser.kt`
- 实现 **SRT 字幕解析器** `SRTSubtitleParser`
  - 支持标准 SRT 格式（00:00:10,500 --> 00:00:13,000）
  - 支持多行字幕文本
- 实现 **VTT 字幕解析器** `VTTSubtitleParser`
  - 支持 WebVTT 格式
  - 自动过滤 VTT 标签（如 `<v Speaker>`）
  - 支持 HH:MM:SS.mmm 和 MM:SS.mmm 两种时间格式

#### 📁 `subtitle/SubtitleManager.kt`
- 字幕文件加载和管理
- 字幕与播放位置同步（100ms 精度）
- 支持启用/禁用字幕显示
- 支持多字幕轨道切换
- 网络下载字幕文件
- 完整的日志记录

#### 📁 `subtitle/SubtitleOverlay.kt`
- Compose 字幕显示组件 `SubtitleOverlay`
  - 半透明黑色背景（75% 不透明度）
  - 白色文字，24sp 大小
  - 居中显示，圆角背景
- 字幕选择对话框 `SubtitleSelectorDialog`
  - 显示/隐藏字幕开关
  - 字幕轨道列表选择
  - TV 友好的交互设计

### 2. 修改的现有文件（1个）

#### 📝 `VideoPlayerScreen.kt`
**新增功能**：
1. ✅ 导入字幕相关的类
2. ✅ 创建字幕管理器实例
3. ✅ 自动加载测试字幕（`test.vtt`）
4. ✅ 启动字幕同步协程
5. ✅ 显示字幕覆盖层（当字幕启用且控制栏隐藏时）
6. ✅ 集成字幕选择对话框
7. ✅ 连接字幕按钮到选择对话框
8. ✅ 在 DisposableEffect 中停止字幕同步

**修改位置**：
```kotlin
// 行 56-60：导入字幕相关类
import com.google.jetstream.presentation.screens.videoPlayer.subtitle.*

// 行 150：添加 coroutineScope
val coroutineScope = rememberCoroutineScope()

// 行 159-164：创建字幕管理器和状态
val subtitleManager = remember { SubtitleManager() }
val currentSubtitle by subtitleManager.currentSubtitle
// ...

// 行 167-187：自动加载测试字幕
LaunchedEffect(Unit) {
    val testSubtitles = listOf(
        SubtitleTrack(
            name = "测试字幕",
            url = "https://raw.githubusercontent.com/cjlhll/openclash-rules/refs/heads/main/test.vtt",
            language = "zh",
            format = SubtitleFormat.VTT
        )
    )
    subtitleManager.setAvailableSubtitles(testSubtitles)
    subtitleManager.loadSubtitle(testSubtitles.first())
    subtitleManager.startSync(coroutineScope)
}

// 行 241：停止字幕同步
subtitleManager.stopSync()

// 行 500-502：连接字幕按钮
onClickSubtitles = { 
    showSubtitleSelector = true
}

// 行 510-518：字幕显示层
if (currentSubtitle != null && subtitleEnabled && !videoPlayerState.isControlsVisible) {
    SubtitleOverlay(
        subtitle = currentSubtitle!!,
        modifier = Modifier
            .align(Alignment.BottomCenter)
            .padding(bottom = 120.dp)
    )
}

// 行 535-551：字幕选择对话框
if (showSubtitleSelector) {
    SubtitleSelectorDialog(
        availableSubtitles = availableSubtitles,
        selectedSubtitle = selectedSubtitle,
        enabled = subtitleEnabled,
        onDismiss = { showSubtitleSelector = false },
        onSubtitleSelected = { track ->
            coroutineScope.launch {
                subtitleManager.loadSubtitle(track)
            }
            showSubtitleSelector = false
        },
        onToggleEnabled = {
            subtitleManager.toggleEnabled()
        }
    )
}
```

### 3. 创建的文档文件（2个）

#### 📄 `docs/字幕功能使用说明.md`
- 完整的功能说明
- 使用方法（三种方式）
- 技术实现原理
- 调试与日志
- 故障排查指南
- 后续优化建议

#### 📄 `docs/字幕功能实现总结.md`
- 本文档，总结所有改动

---

## 🎯 核心功能特性

### 自动加载测试字幕
✅ 播放视频时自动加载：https://raw.githubusercontent.com/cjlhll/openclash-rules/refs/heads/main/test.vtt

### 字幕格式支持
✅ **VTT** (WebVTT) - 已实现  
✅ **SRT** (SubRip) - 已实现  
⏳ **ASS** (Advanced SubStation Alpha) - 预留接口  
⏳ **TTML** (Timed Text Markup Language) - 预留接口

### 字幕同步
✅ 精度：100ms 轮询间隔  
✅ 自动匹配播放位置  
✅ 支持快进/快退/暂停时同步

### 显示控制
✅ 启用/禁用字幕显示  
✅ 控制栏显示时自动隐藏字幕  
✅ 字幕选择对话框

### UI 设计
✅ 半透明黑色背景（75% 不透明度）  
✅ 白色文字，24sp 字号  
✅ 居中底部显示，距离底部 120dp  
✅ 圆角背景，TV 友好设计

---

## 🔧 技术架构

### 架构图
```
┌─────────────────────────────────────┐
│  VideoPlayerScreen.kt                │
│  - 字幕管理器实例                     │
│  - 字幕状态管理                       │
│  - 字幕显示逻辑                       │
├─────────────────────────────────────┤
│  SubtitleManager.kt                  │
│  - 加载字幕文件                       │
│  - 同步播放位置                       │
│  - 查找当前字幕                       │
├─────────────────────────────────────┤
│  SubtitleParser.kt                   │
│  - SRT 格式解析                       │
│  - VTT 格式解析                       │
├─────────────────────────────────────┤
│  SubtitleOverlay.kt                  │
│  - 字幕显示组件                       │
│  - 字幕选择对话框                     │
└─────────────────────────────────────┘
```

### 关键代码流程

#### 1. 字幕加载流程
```kotlin
LaunchedEffect(Unit) {
    // 1. 设置可用字幕列表
    subtitleManager.setAvailableSubtitles(testSubtitles)
    
    // 2. 加载字幕文件（网络下载 + 解析）
    subtitleManager.loadSubtitle(track)
    
    // 3. 开始同步协程
    subtitleManager.startSync(coroutineScope)
}
```

#### 2. 字幕同步流程
```kotlin
fun startSync(coroutineScope: CoroutineScope) {
    syncJob = coroutineScope.launch {
        while (isActive) {
            // 1. 获取当前播放位置
            val currentPos = GSYVideoManager.instance().currentPosition
            
            // 2. 查找对应的字幕项
            _currentSubtitle.value = findSubtitleAtPosition(currentPos)
            
            // 3. 等待 100ms
            delay(100)
        }
    }
}
```

#### 3. 字幕显示流程
```kotlin
if (currentSubtitle != null && subtitleEnabled && !videoPlayerState.isControlsVisible) {
    SubtitleOverlay(
        subtitle = currentSubtitle!!,
        modifier = Modifier.align(Alignment.BottomCenter)
    )
}
```

---

## 📋 测试清单

### 基础功能测试
- [ ] 播放视频时字幕自动加载
- [ ] 字幕内容正确显示
- [ ] 字幕时间同步准确

### 交互功能测试
- [ ] 点击字幕按钮打开选择对话框
- [ ] 可以切换显示/隐藏字幕
- [ ] 控制栏显示时字幕自动隐藏

### 播放控制测试
- [ ] 快进/快退时字幕正常跟随
- [ ] 暂停时字幕保持显示
- [ ] 内核切换时字幕继续工作

### 生命周期测试
- [ ] 退出播放器时字幕停止同步
- [ ] 应用切换到后台时字幕正常
- [ ] 重新进入播放器时字幕恢复

---

## 📊 代码统计

| 文件 | 代码行数 | 功能 |
|------|---------|------|
| SubtitleItem.kt | ~40 行 | 数据模型 |
| SubtitleParser.kt | ~170 行 | 字幕解析 |
| SubtitleManager.kt | ~140 行 | 字幕管理 |
| SubtitleOverlay.kt | ~110 行 | UI 显示 |
| VideoPlayerScreen.kt | +30 行 | 集成修改 |
| **总计** | **~490 行** | **新增代码** |

---

## 🚀 如何测试

### 步骤 1：编译项目
```bash
# 在项目根目录运行
./gradlew :jetstream:assembleDebug
```

### 步骤 2：安装到 TV 设备
```bash
adb install -r jetstream/build/outputs/apk/debug/jetstream-debug.apk
```

### 步骤 3：播放视频
1. 打开应用
2. 选择任意视频播放
3. **字幕会自动加载和显示**

### 步骤 4：查看日志
```bash
# 查看字幕相关日志
adb logcat | grep -E "SubtitleManager|VideoPlayer|VTTParser"

# 应该看到类似输出：
# VideoPlayer: Auto-loading subtitle: https://raw.githubusercontent.com/.../test.vtt
# SubtitleManager: Loading subtitle from: https://raw.githubusercontent.com/.../test.vtt
# SubtitleManager: Downloaded XXXXX bytes
# SubtitleManager: Loaded 123 subtitle items
```

### 步骤 5：测试字幕控制
1. 播放过程中按**上键或下键**显示控制栏
2. 选中**字幕按钮**（Subtitles 图标）
3. 在对话框中选择"隐藏字幕"或"显示字幕"

---

## 🐛 常见问题排查

### 问题 1：字幕不显示

**检查步骤**：
1. 查看日志是否有 "Loaded XX subtitle items"
2. 检查网络是否可以访问 `raw.githubusercontent.com`
3. 检查字幕是否被禁用（`subtitleEnabled` 状态）

**解决方法**：
```bash
# 测试网络连接
curl https://raw.githubusercontent.com/cjlhll/openclash-rules/refs/heads/main/test.vtt

# 查看日志错误
adb logcat | grep -E "SubtitleManager|ERROR"
```

### 问题 2：字幕时间不同步

**可能原因**：
- 字幕文件的时间戳与视频不匹配（这是测试字幕，可能与你的视频不对应）

**解决方法**：
- 使用与视频匹配的字幕文件
- 待实现：字幕延迟调整功能

### 问题 3：字幕显示异常字符

**可能原因**：
- 字幕文件不是 UTF-8 编码

**解决方法**：
- 确保字幕文件使用 UTF-8 编码
- 检查解析器是否正确处理特殊字符

---

## 📝 后续优化建议

### 1. 字幕延迟调整（高优先级）
```kotlin
// 在设置对话框中添加延迟调整
fun setDelay(delayMs: Long) {
    subtitleManager.setDelay(delayMs)
}
```

### 2. 字幕样式自定义（中优先级）
```kotlin
// 允许用户自定义字幕样式
data class SubtitleStyle(
    val fontSize: TextUnit,
    val textColor: Color,
    val backgroundColor: Color,
    val position: SubtitlePosition
)
```

### 3. 字幕文件缓存（中优先级）
```kotlin
// 将下载的字幕缓存到本地，避免重复下载
suspend fun loadSubtitle(track: SubtitleTrack) {
    val cachedFile = getCachedSubtitleFile(track)
    if (cachedFile.exists()) {
        // 使用缓存
    } else {
        // 下载并缓存
    }
}
```

### 4. 内嵌字幕支持（低优先级）
```kotlin
// 支持视频文件内嵌的字幕轨道（MKV、MP4）
// 需要通过 Media3 API 获取内嵌字幕
```

### 5. ASS 字幕样式支持（低优先级）
```kotlin
// 实现 ASS 格式的高级样式（颜色、位置、动画）
class ASSSubtitleParser {
    fun parseASS(content: String): List<SubtitleItem> {
        // TODO: 解析 ASS 格式
    }
}
```

---

## ✅ 总结

### 已完成
1. ✅ 创建完整的字幕模块（4 个新文件）
2. ✅ 集成到现有播放器（修改 VideoPlayerScreen.kt）
3. ✅ 支持 SRT 和 VTT 格式
4. ✅ 自动加载测试字幕
5. ✅ 实现字幕同步显示
6. ✅ 实现字幕控制功能
7. ✅ 编写完整文档

### 下一步
1. ⏳ **测试字幕功能**（需要在 TV 设备上运行）
2. ⏳ 根据测试结果调整和优化
3. ⏳ 实现字幕延迟调整功能
4. ⏳ 添加从 MovieDetails 动态加载字幕的逻辑

---

**实现时间**：2025-10-24  
**测试字幕链接**：https://raw.githubusercontent.com/cjlhll/openclash-rules/refs/heads/main/test.vtt  
**代码状态**：✅ 无编译错误，可以直接运行测试

