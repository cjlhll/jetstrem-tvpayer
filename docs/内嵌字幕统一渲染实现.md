# 内嵌字幕统一渲染实现方案

## 实现目标

将内嵌字幕（MKV、MP4 等格式）的渲染统一到我们自己的字幕系统，而不是让 ExoPlayer 自己渲染，便于后期维护和功能扩展。

---

## 技术方案

### 核心思路

1. **检测内嵌字幕轨道** - 通过 ExoPlayer API 获取字幕轨道信息
2. **监听字幕数据** - 使用 Player.Listener 的 onCues 回调实时获取字幕
3. **统一渲染** - 将内嵌字幕数据传递给 SubtitleManager，使用 SubtitleOverlay 显示
4. **禁用 ExoPlayer 自带渲染** - ExoPlayer 只提供数据，不显示字幕

### 数据流向

```
视频文件 (MKV/MP4)
    ↓
ExoPlayer 解析字幕轨道
    ↓
Player.Listener.onCues() 回调
    ↓
SubtitleManager.updateEmbeddedSubtitle()
    ↓
SubtitleOverlay 统一渲染 ✨
```

---

## 核心组件

### 1. EmbeddedSubtitleExtractor（提取器）

**功能**：
- 检测视频是否包含内嵌字幕
- 提取字幕轨道信息（语言、格式、标签）
- 选择最佳字幕轨道（按语言优先级）

**关键方法**：

```kotlin
// 检测视频是否可能包含内嵌字幕
fun mayHaveEmbeddedSubtitles(videoUri: String): Boolean

// 提取所有字幕轨道
suspend fun extractSubtitleTracks(
    player: StandardGSYVideoPlayer
): List<EmbeddedSubtitleTrack>

// 选择最佳字幕轨道（按语言优先级）
fun selectBestSubtitle(tracks: List<EmbeddedSubtitleTrack>): EmbeddedSubtitleTrack?
```

**语言优先级**：
1. 简英双语
2. 简体中文
3. 繁英双语
4. 繁体中文
5. 英语

### 2. SubtitleManager（字幕管理器）

**新增方法**：

```kotlin
// 标记检测到内嵌字幕
fun markEmbeddedSubtitleDetected(track: EmbeddedSubtitleTrack)

// 实时更新内嵌字幕（从 ExoPlayer 回调）
fun updateEmbeddedSubtitle(text: String, startTimeMs: Long, endTimeMs: Long)

// 清除内嵌字幕显示
fun clearEmbeddedSubtitle()
```

**工作原理**：
- 内嵌字幕不使用 `subtitleItems` 列表（因为是实时接收）
- 直接更新 `_currentSubtitle` 状态
- `enabled` 状态控制是否显示

### 3. VideoPlayerScreen（播放器界面）

**新增函数**：

```kotlin
// 配置内嵌字幕监听器
private fun setupEmbeddedSubtitleListener(
    player: StandardGSYVideoPlayer,
    subtitleManager: SubtitleManager
)
```

**监听器实现**：

```kotlin
exoPlayer.addListener(object : Player.Listener {
    override fun onCues(cueGroup: CueGroup) {
        // 1. 获取当前播放位置
        val currentPosition = exoPlayer.currentPosition
        
        // 2. 合并所有字幕行
        val text = cueGroup.cues.joinToString("\n") { cue ->
            cue.text?.toString() ?: ""
        }
        
        // 3. 更新字幕管理器
        if (text.isNotBlank()) {
            subtitleManager.updateEmbeddedSubtitle(
                text, 
                currentPosition, 
                currentPosition + 3000
            )
        } else {
            subtitleManager.clearEmbeddedSubtitle()
        }
    }
})
```

---

## 完整工作流程

### 1. 视频准备完成（onPrepared）

```kotlin
override fun onPrepared(url: String, vararg objects: Any) {
    // 检查文件扩展名
    if (EmbeddedSubtitleExtractor.mayHaveEmbeddedSubtitles(url)) {
        
        // 异步提取字幕轨道
        coroutineScope.launch {
            val tracks = EmbeddedSubtitleExtractor.extractSubtitleTracks(player)
            
            if (tracks.isNotEmpty()) {
                // 选择最佳轨道
                val bestTrack = EmbeddedSubtitleExtractor.selectBestSubtitle(tracks)
                
                if (bestTrack != null) {
                    // 标记字幕管理器
                    subtitleManager.markEmbeddedSubtitleDetected(bestTrack)
                    
                    // 配置监听器
                    setupEmbeddedSubtitleListener(player, subtitleManager)
                }
            }
        }
    }
}
```

### 2. 实时字幕更新（onCues 回调）

```kotlin
ExoPlayer 解码字幕
    ↓
onCues(cueGroup) 触发
    ↓
提取文本内容
    ↓
subtitleManager.updateEmbeddedSubtitle(text, start, end)
    ↓
更新 _currentSubtitle 状态
    ↓
SubtitleOverlay 显示 ✨
```

### 3. 用户控制

```kotlin
// 用户打开字幕开关
subtitleManager.setEnabled(true)
    ↓
_enabled.value = true
    ↓
内嵌字幕开始显示

// 用户关闭字幕开关
subtitleManager.setEnabled(false)
    ↓
_enabled.value = false
    ↓
内嵌字幕停止显示
```

---

## 关键技术点

### 1. 反射访问 ExoPlayer

```kotlin
val exoPlayerField = player.javaClass.getDeclaredField("exoPlayer")
exoPlayerField.isAccessible = true
val exoPlayer = exoPlayerField.get(player) as? ExoPlayer
```

**原因**：GSYVideoPlayer 封装了 ExoPlayer，需要通过反射访问

### 2. ExoPlayer Player.Listener

```kotlin
exoPlayer.addListener(object : Player.Listener {
    override fun onCues(cueGroup: CueGroup) {
        // 实时接收字幕数据
    }
})
```

**优点**：
- ✅ 实时接收，无延迟
- ✅ ExoPlayer 自动解码，支持所有格式
- ✅ 自动处理字幕轨道切换

### 3. CueGroup 数据结构

```kotlin
data class CueGroup(
    val cues: List<Cue>,  // 当前时间点的所有字幕
    val presentationTimeUs: Long
)

data class Cue(
    val text: CharSequence?,  // 字幕文本
    val textAlignment: Layout.Alignment?,  // 对齐方式
    val line: Float,  // 行位置
    val position: Float,  // 列位置
    // ... 更多样式属性
)
```

**处理**：合并多行字幕显示

---

## 优势对比

### 之前的方案（ExoPlayer 自己渲染）

❌ **缺点**：
- 样式固定，无法自定义
- 无法调整字幕延迟
- 字幕位置和大小不可控
- 难以统一管理

### 现在的方案（统一渲染）

✅ **优点**：
- **统一样式**：所有字幕（内嵌/外部/ASSRT）使用相同样式
- **可自定义**：字体、颜色、位置、大小都可调整
- **延迟控制**：可以调整字幕显示延迟
- **易于维护**：所有字幕逻辑集中在 SubtitleManager
- **扩展性强**：未来可以添加更多功能（双语对照、字幕翻译等）

---

## 日志输出

### 成功流程

```
VideoPlayer: 视频可能包含内嵌字幕，开始提取
EmbeddedSubtitleExtractor: 发现内嵌字幕轨道: 简体中文 (zh) - SRT
EmbeddedSubtitleExtractor: 发现内嵌字幕轨道: English (en) - SRT
EmbeddedSubtitleExtractor: 共发现 2 个内嵌字幕轨道
EmbeddedSubtitleExtractor: 选择字幕轨道: 简体中文 (zh)
VideoPlayer: 选中内嵌字幕: 简体中文
SubtitleManager: 检测到内嵌字幕: 简体中文 (zh)
VideoPlayer: 内嵌字幕监听器已配置
EmbeddedSubtitle: 字幕: 欢迎来到侏罗纪世界
EmbeddedSubtitle: 字幕: 准备好了吗？
...
```

### 无内嵌字幕

```
VideoPlayer: 视频可能包含内嵌字幕，开始提取
EmbeddedSubtitleExtractor: 共发现 0 个内嵌字幕轨道
VideoPlayer: 未发现内嵌字幕轨道
```

此时用户开启字幕会触发 ASSRT API 搜索。

---

## 与外部字幕的区别

| 特性 | 内嵌字幕 | 外部字幕（ASSRT API） |
|------|---------|-------------------|
| 数据来源 | ExoPlayer 实时解码 | 下载后解析 |
| 数据存储 | 不存储，实时接收 | 存储在 subtitleItems 列表 |
| 同步方式 | ExoPlayer 自动同步 | 手动同步（根据播放位置） |
| 延迟调整 | 暂不支持 | 支持 |
| 格式支持 | ExoPlayer 支持的所有格式 | SRT/VTT/ASS/TTML |
| 渲染方式 | SubtitleOverlay（统一） | SubtitleOverlay（统一） |

---

## 后续优化

### 1. 字幕延迟调整

```kotlin
fun updateEmbeddedSubtitle(text: String, startTimeMs: Long, endTimeMs: Long) {
    // 应用用户设置的延迟
    val adjustedStart = startTimeMs + _delayMs.value
    val adjustedEnd = endTimeMs + _delayMs.value
    
    _currentSubtitle.value = SubtitleItem(adjustedStart, adjustedEnd, text)
}
```

### 2. 多轨道切换

```kotlin
// 允许用户在字幕设置中切换轨道
fun switchEmbeddedSubtitleTrack(track: EmbeddedSubtitleTrack) {
    // 通过 ExoPlayer API 切换激活的字幕轨道
    // exoPlayer.trackSelectionParameters = ...
}
```

### 3. 字幕样式自定义

```kotlin
// 在 SubtitleOverlay 中应用用户自定义样式
SubtitleOverlay(
    subtitle = currentSubtitle,
    style = SubtitleStyle(
        fontSize = userPreferences.subtitleFontSize,
        color = userPreferences.subtitleColor,
        backgroundColor = userPreferences.subtitleBackgroundColor
    )
)
```

---

## 测试建议

### 测试用例

| 测试场景 | 预期结果 |
|---------|---------|
| 播放包含简体字幕的 MKV | 自动显示简体字幕 |
| 播放包含多轨道字幕的 MKV | 自动选择简体轨道 |
| 播放无字幕的 MKV | 不显示，开启时调用 ASSRT API |
| 开关字幕开关 | 内嵌字幕显示/隐藏 |
| ASS 格式内嵌字幕 | 正确清理格式标签 |
| 双语字幕 | 正确显示两行 |

### 调试日志

```bash
adb logcat -s VideoPlayer:D EmbeddedSubtitleExtractor:D SubtitleManager:D EmbeddedSubtitle:D
```

---

## 总结

✅ **实现完成**：内嵌字幕现在使用统一的渲染系统  
✅ **编译成功**：`BUILD SUCCESSFUL in 10s`  
✅ **架构统一**：所有字幕都通过 SubtitleOverlay 显示  
✅ **易于维护**：字幕逻辑集中在 SubtitleManager  
✅ **扩展性强**：为未来功能预留了接口  

---

*文档更新时间: 2025-10-24*  
*实现版本: v2.0 - 统一渲染*

