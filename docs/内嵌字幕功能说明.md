# 内嵌字幕自动检测与挂载功能

## 功能概述

自动检测视频文件（MKV、MP4等）中的内嵌字幕轨道，并优先使用内嵌字幕，避免不必要的外部字幕搜索。

---

## 工作流程

```
播放视频
    ↓
视频准备完成 (onPrepared)
    ↓
检查文件扩展名 (.mkv, .mp4, .m4v, .webm)
    ↓
是否可能包含内嵌字幕？
    ├── 否 → 正常播放，用户开启字幕时调用 ASSRT API
    └── 是 ↓
        尝试访问 ExoPlayer 实例
            ↓
        检查是否有文本轨道 (TRACK_TYPE_TEXT)
            ↓
        有字幕轨道？
            ├── 否 → 记录日志，用户开启字幕时调用 ASSRT API
            └── 是 ↓
                记录字幕轨道信息（语言、格式）
                    ↓
                标记 SubtitleManager: hasAutoSearched = true
                    ↓
                自动启用字幕显示
                    ↓
                ExoPlayer 自动渲染内嵌字幕 ✨
```

---

## 核心组件

### 1. EmbeddedSubtitleExtractor（内嵌字幕检测器）

**文件位置**: `jetstream/src/main/java/com/google/jetstream/presentation/screens/videoPlayer/subtitle/EmbeddedSubtitleExtractor.kt`

#### 主要方法

| 方法 | 功能 | 参数 | 返回 |
|------|------|------|------|
| `mayHaveEmbeddedSubtitles()` | 根据文件扩展名判断是否可能包含内嵌字幕 | videoUri: String | Boolean |
| `enableEmbeddedSubtitles()` | 启用播放器的内嵌字幕渲染并记录日志 | player: StandardGSYVideoPlayer | void |

#### 支持的格式

- `.mkv` - Matroska (最常见)
- `.mp4` - MPEG-4
- `.m4v` - iTunes 视频
- `.webm` - WebM

---

### 2. SubtitleManager 修改

**新增方法**: `markEmbeddedSubtitleDetected()`

```kotlin
fun markEmbeddedSubtitleDetected() {
    hasAutoSearched = true  // 标记已有字幕
    _enabled.value = true   // 自动启用字幕
    Log.d("SubtitleManager", "检测到内嵌字幕，已启用（由播放器渲染）")
}
```

**作用**:
- 标记已检测到字幕，避免调用 ASSRT API
- 自动启用字幕显示
- 内嵌字幕由 ExoPlayer 直接渲染，不经过我们的 SubtitleOverlay

---

### 3. VideoPlayerScreen 修改

在 `onPrepared` 回调中添加检测逻辑：

```kotlin
override fun onPrepared(url: String, vararg objects: Any) {
    super.onPrepared(url, *objects)
    Log.d("VideoPlayer", "Video prepared with core: $currentCore")
    
    // 检测并启用内嵌字幕
    if (EmbeddedSubtitleExtractor.mayHaveEmbeddedSubtitles(url)) {
        Log.d("VideoPlayer", "视频可能包含内嵌字幕，尝试启用")
        EmbeddedSubtitleExtractor.enableEmbeddedSubtitles(this@apply)
        // 标记字幕管理器，避免调用 ASSRT API
        subtitleManager.markEmbeddedSubtitleDetected()
    }
    
    // ... 其他逻辑
}
```

---

## 技术实现细节

### 1. 为什么让 ExoPlayer 自己渲染？

**优点**：
- ✅ **简单高效**：无需提取和解析字幕数据
- ✅ **性能最优**：ExoPlayer 原生支持，无额外开销
- ✅ **格式完整**：支持所有 ExoPlayer 支持的字幕格式
- ✅ **样式保留**：保留原始字幕样式和格式

**缺点**：
- ❌ **样式固定**：无法使用我们自定义的字幕样式（字体、颜色、位置）
- ❌ **延迟控制**：无法调整字幕延迟（但内嵌字幕通常不需要）

### 2. 检测方法

采用 **反射 + 类型检查** 方式：

```kotlin
// 1. 通过反射获取 ExoPlayer 实例
val exoPlayerField = player.javaClass.getDeclaredField("exoPlayer")
exoPlayerField.isAccessible = true
val exoPlayer = exoPlayerField.get(player) as? ExoPlayer

// 2. 检查轨道信息
val tracks = exoPlayer.currentTracks
for (trackGroup in tracks.groups) {
    if (trackGroup.type == C.TRACK_TYPE_TEXT) {
        // 发现字幕轨道
        for (i in 0 until trackGroup.length) {
            val format = trackGroup.getTrackFormat(i)
            val language = format.language ?: "und"
            val label = format.label ?: language
            Log.d(TAG, "发现内嵌字幕轨道: $label ($language)")
        }
    }
}
```

### 3. 语言优先级（预留）

虽然当前实现让 ExoPlayer 自动选择，但代码中预留了语言优先级逻辑（与 ASSRT API 保持一致）：

```kotlin
简英双语 → 简体中文 → 繁英双语 → 繁体中文 → 英语
```

未来可以扩展为手动选择字幕轨道。

---

## 日志输出

### 成功检测到内嵌字幕

```
VideoPlayer: Video prepared with core: MEDIA3
VideoPlayer: 视频可能包含内嵌字幕，尝试启用
EmbeddedSubtitleExtractor: 发现内嵌字幕轨道: 简体中文 (zh)
EmbeddedSubtitleExtractor: 发现内嵌字幕轨道: English (en)
EmbeddedSubtitleExtractor: 视频包含内嵌字幕，ExoPlayer 将自动渲染
SubtitleManager: 检测到内嵌字幕，已启用（由播放器渲染）
```

### 没有内嵌字幕

```
VideoPlayer: Video prepared with core: MEDIA3
VideoPlayer: 视频可能包含内嵌字幕，尝试启用
EmbeddedSubtitleExtractor: 视频不包含内嵌字幕轨道
```

此时如果用户打开字幕开关，会触发 ASSRT API 搜索。

---

## 优先级策略

| 场景 | 行为 |
|------|------|
| 1. 视频包含内嵌字幕 | ✅ 自动启用内嵌字幕，**不调用 ASSRT API** |
| 2. 视频无内嵌字幕 + 用户开启字幕 | 调用 ASSRT API 搜索外部字幕 |
| 3. 视频无内嵌字幕 + 用户未开启字幕 | 不做任何操作 |

---

## 用户体验

### 对于包含内嵌字幕的视频

1. **播放开始** → 自动检测到内嵌字幕
2. **字幕自动开启** → 无需用户操作
3. **字幕立即显示** → 由 ExoPlayer 渲染，零延迟
4. **节省流量** → 不下载外部字幕文件

### 对于不包含内嵌字幕的视频

1. **播放开始** → 检测到无内嵌字幕
2. **用户手动开启字幕** → 触发 ASSRT API 搜索
3. **自动下载匹配字幕** → 按语言优先级
4. **字幕开始显示** → 使用自定义 SubtitleOverlay

---

## 已知限制

1. **样式固定**：内嵌字幕使用播放器默认样式，无法自定义
2. **延迟调整**：无法调整内嵌字幕的显示延迟
3. **检测时机**：只能在视频准备完成后检测，初始加载时可能有短暂延迟
4. **反射访问**：使用反射访问 ExoPlayer，可能在未来版本失效

---

## 未来扩展

### 1. 手动选择字幕轨道

```kotlin
// 扩展字幕配置对话框，显示所有可用轨道
fun showSubtitleTrackSelector(tracks: List<EmbeddedSubtitleTrack>) {
    // UI: 显示轨道列表（简体中文、English、日本語等）
    // 用户选择后，切换 ExoPlayer 的激活轨道
}
```

### 2. 语言智能选择

```kotlin
// 根据系统语言或用户偏好自动选择最佳轨道
fun selectBestSubtitleTrack(tracks: List<EmbeddedSubtitleTrack>): EmbeddedSubtitleTrack {
    val systemLanguage = Locale.getDefault().language
    return tracks.sortedBy { 
        languagePriority(it.language, systemLanguage) 
    }.first()
}
```

### 3. 混合模式

```kotlin
// 内嵌字幕 + 外部字幕同时显示（双语学习）
// 内嵌字幕在上方，外部字幕在下方
```

---

## 测试建议

### 测试用例

| 测试场景 | 预期结果 |
|---------|---------|
| 播放 MKV 文件（含简体字幕） | 自动显示内嵌字幕，不调用 API |
| 播放 MKV 文件（无字幕） | 不显示字幕，开启时调用 API |
| 播放 MP4 文件（含字幕） | 自动显示内嵌字幕 |
| 播放 AVI 文件 | 不检测内嵌字幕，直接调用 API |
| 切换播放内核 | 重新检测内嵌字幕 |

### 日志检查

```bash
adb logcat -s VideoPlayer:D EmbeddedSubtitleExtractor:D SubtitleManager:D
```

---

## 总结

✅ **功能完整**：自动检测、优先使用、智能回退  
✅ **性能优化**：零延迟、无额外下载  
✅ **用户友好**：自动启用、无需配置  
✅ **扩展性强**：预留多轨道选择接口  

---

*文档更新时间: 2025-10-24*  
*功能版本: v1.0*

